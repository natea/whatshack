# HLT-TC-003: User Self-Service Data Erasure (POPIA Right to be Forgotten)

**Version:** 1.0
**Date:** May 17, 2025
**Author:** AI Assistant (Gemini)

## 1. Test Overview
This High-Level Test (HLT) verifies that a user can initiate a self-service data erasure request using the `/delete` command, and that the system subsequently removes or fully anonymizes all their Personally Identifiable Information (PII) in compliance with POPIA's "Right to be Forgotten."

## 2. User Story / Scenario
*   **User Story (PRD 4.1):** *As a user, I want to be able to send `/delete` to erase my data so I have control over my personal information.*
*   **Scenario (HLT Strategy 4.1):** A user requests data erasure. User sends `/delete`, system confirms, and all associated user data is verifiably removed from Supabase.
*   **Feature (PRD 5.1):** Self-Service Data Erasure: `/delete` command to wipe user data.

## 3. Preconditions
*   The test user is already onboarded, has provided POPIA consent, and has some data stored in the system (e.g., profile information, transaction logs, language preference). Let's assume the user ID is `test_user_for_deletion_123` and phone number is `+27000000123`.
*   The `/delete` command functionality is implemented, including a confirmation step.
*   The data erasure mechanism (e.g., Supabase function `hard_delete_user_data()`) is implemented and configured to remove or fully anonymize all PII associated with a user ID.
*   Admin access to Supabase is available to verify data removal post-test.

## 4. Test Steps

| Step | User Action (via WhatsApp)                  | Expected System Response (WhatsApp Message & Backend)                                                                                                                                                                                                                                                                                          | AI Verifiable Checks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| :--- | :------------------------------------------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1    | User sends: `/delete`                       | **System (WhatsApp):** Responds with a confirmation prompt in the user's current language (e.g., English: "Are you sure you want to delete all your data? This action cannot be undone. Reply 'YES DELETE' to confirm or 'CANCEL' to abort.").<br>**System (Backend):** Logs the initial `/delete` request. No data is deleted yet.                  | WhatsApp response received matches the expected confirmation prompt in the user's language. Backend logs show the initial `/delete` request event. Supabase query confirms user data for `test_user_for_deletion_123` still exists.                                                                                                                                                                                                                                                                                                                                                                                        |
| 2    | User sends: `CANCEL` (or any non-confirm text) | **System (WhatsApp):** Responds with a cancellation message in the user's current language (e.g., "Data deletion cancelled. Your data has not been removed.").\<br>**System (Backend):** Logs the cancellation.                                                                                                                                    | WhatsApp response received matches the expected cancellation message. Supabase query confirms user data for `test_user_for_deletion_123` still exists and is unchanged. Backend logs show the cancellation event.                                                                                                                                                                                                                                                                                                                                                                                                          |
| 3    | User sends: `/delete` (again)               | **System (WhatsApp):** Responds with the same confirmation prompt as in Step 1.<br>**System (Backend):** Logs the new `/delete` request.                                                                                                                                                                                                             | Same as Step 1 verification.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 4    | User sends: `YES DELETE`                    | **System (WhatsApp):** Responds with a final confirmation message (e.g., "Your data deletion request has been processed. All your personal information has been removed from Township Connect. Thank you for using our service.").\<br>**System (Backend):** Triggers the data erasure process (e.g., calls `hard_delete_user_data('test_user_for_deletion_123')`). Logs the successful data deletion. | WhatsApp response received matches the expected final confirmation message. Backend logs show the `YES DELETE` confirmation and the initiation and successful completion of the data erasure process for `test_user_for_deletion_123`. Supabase queries (see AC-02, AC-03, AC-04 below) verify data removal/anonymization.                                                                                                                                                                                                                                                                                                   |
| 5    | Attempt to interact with the service again (e.g., send "Hi") | **System (WhatsApp):** Treats the user as a new, unrecognized user. Initiates the new user onboarding flow (e.g., asks for language, presents POPIA notice again if the phone number is still used).<br>**System (Backend):** No existing user session found for `+27000000123`.                                                              | WhatsApp response is consistent with a new user interaction (e.g., language prompt or welcome for new user). Backend logs show no existing active session for the phone number, or a new session being created if the system re-onboards. Supabase query for `+27000000123` or `test_user_for_deletion_123` should not find any PII or link to previous activity (unless re-onboarding creates a new blank record). |

## 5. Acceptance Criteria
*   **AC-01:** The system requires explicit confirmation from the user before proceeding with data erasure.
    *   **AI Verifiable:** WhatsApp message content for the `/delete` command includes a clear warning and a specific confirmation phrase (e.g., "YES DELETE"). Data is not deleted if confirmation is not provided or if "CANCEL" is sent.
*   **AC-02:** Upon confirmed request, all PII associated with the user (e.g., name, phone number if not used as primary key for future blocks, transaction history, message logs directly linked to user, preferences) is verifiably removed or fully anonymized from the Supabase database.
    *   **AI Verifiable:** Direct Supabase queries for the `test_user_for_deletion_123` ID or `+27000000123` phone number (after erasure) return no PII. Check relevant tables (e.g., `users`, `transactions`, `messages`, `preferences`). Anonymized records might exist but must not contain linkable PII.
*   **AC-03:** The system sends a final confirmation message to the user after the data erasure process is completed.
    *   **AI Verifiable:** WhatsApp message content matches the expected "deletion complete" notification.
*   **AC-04:** After data erasure, the user is treated as a new user if they attempt to interact with the service again using the same phone number.
    *   **AI Verifiable:** Subsequent messages from the same phone number trigger the new user onboarding flow. Supabase query shows no PII from the *previous* user profile associated with the phone number.
*   **AC-05:** The data erasure process is logged for audit purposes.
    *   **AI Verifiable:** Application logs contain entries for the `/delete` request, user confirmation, and successful completion of the erasure process, including the user ID affected.
*   **AC-06:** The `/delete` command interaction is data-efficient (≤5KB per interaction).
    *   **AI Verifiable:** Network monitoring tool output (or payload size calculation) for each step shows data ≤5KB.

## 6. Dependencies & Assumptions
*   The Supabase function or equivalent logic for `hard_delete_user_data()` is robust and correctly identifies all tables and fields containing PII for a given user.
*   The definition of PII for Township Connect is clearly established and reflected in the erasure logic.
*   The system can still send a final confirmation message via WhatsApp even after the user's data is deleted (e.g., the message is queued before full erasure or uses the phone number temporarily).

## 7. References
*   PRD Section: 4.1 (User Onboarding & Setup - `/delete` command), 5.1 (Account Management & Onboarding - Self-Service Data Erasure), 8.6 (Compliance - POPIA Right to be Forgotten).
*   High-Level Test Strategy Report Section: 4.1 (User Onboarding & Account Management - Data Erasure), 4.5 (POPIA Compliance - Data Erasure Confirmation).
*   Master Acceptance Test Plan: HLT-TC-003.
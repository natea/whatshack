# HLT-TC-008: Expense Tracking

**Version:** 1.0
**Date:** May 17, 2025
**Author:** AI Assistant (Gemini)

## 1. Test Overview
This High-Level Test (HLT) verifies that an SME user can successfully log a business expense using a simple command via Township Connect.

## 2. User Story / Scenario
*   **User Story (PRD 4.2):** *As a tutor, I want to track my expenses by sending "Expense R50 airtime" so I have a simple record.*
*   **Feature (PRD 5.2):** Expense Tracking: Simple command to track business expenses.
*   **Scenario (HLT Strategy 4.2):** A tutor tracks an expense. Tutor sends "Expense R50 airtime", system confirms and logs the expense.

## 3. Preconditions
*   The test user is an onboarded SME user with a service bundle that includes expense tracking (e.g., "Street-Vendor CRM" or a general SME bundle).
*   User's language is set (e.g., English).
*   The system is configured to parse commands like "Expense [amount] [description]" or "Expense R[amount] [description]".
*   The Supabase database has a table (e.g., `transactions` or `expenses_log`) to store expense records, linked to user IDs.

## 4. Test Steps

| Step | User Action (via WhatsApp)           | Expected System Response (WhatsApp Message & Backend)                                                                                                                                                                                                                                                                                                                             | AI Verifiable Checks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| :--- | :----------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1    | User sends: "Expense 50 airtime"     | **System (WhatsApp):** Responds with a confirmation message in English (e.g., "Expense of R50.00 for 'airtime' logged successfully." or "Got it! Expense: R50.00 - airtime.").\<br>**System (Backend):** Parses the command, extracts amount (50) and description ("airtime"). Creates a new expense record in the Supabase database associated with the user, including amount, description, and timestamp. | WhatsApp response received matches an expected confirmation format for expense logging, including the amount and description. Supabase query on the `expenses_log` (or `transactions` with type 'expense') table verifies a new record exists for the current user with: `amount = 50.00`, `description = "airtime"`, `transaction_type = "expense"`, and a recent `timestamp`. Backend logs show successful parsing and database insertion.                                                                                                                                                                                                                                                                                                                                                  |
| 2    | User sends: "Expense R35.75 transport costs" | **System (WhatsApp):** Confirms logging (e.g., "Expense of R35.75 for 'transport costs' logged.").\<br>**System (Backend):** Parses amount (35.75) and description ("transport costs"). Logs to Supabase.                                                                                                                                                                        | Similar to Step 1. Supabase record shows `amount = 35.75`, `description = "transport costs"`. The "R" prefix should be handled gracefully if the parser expects it or can ignore it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 3    | User sends: "Expense fifty airtime" (invalid amount format) | **System (WhatsApp):** Responds with an error message in English (e.g., "Sorry, 'fifty' is not a valid amount for an expense. Please use numbers like 50 or 35.75.").\<br>**System (Backend):** Logs failed attempt. No database record created.                                                                                                                                | WhatsApp response matches expected error for invalid amount. No new expense record in Supabase for this attempt. Backend logs show parsing error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 4    | User sends: "Expense 50" (missing description, if description is mandatory) | **System (WhatsApp):** (If description mandatory) Responds with an error message (e.g., "Please provide a description for your expense, like 'Expense 50 airtime'.").<br>**System (Backend):** Logs failed attempt. No database record.                                                                                                                                    | (If description mandatory) WhatsApp response matches expected error for missing description. No new expense record. If description is optional, this step should behave like Step 1 but with a null/empty description in Supabase. Test based on system design.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 5    | User sends: "Log Expense 20 data" (variation of command keyword, if "Log Expense" is also accepted) | **System (WhatsApp):** (If "Log Expense" is accepted) Confirms logging (e.g., "Expense of R20.00 for 'data' logged.").\<br>**System (Backend):** Parses and logs.                                                                                                                                                                                                         | (If "Log Expense" is accepted) Similar to Step 1. Supabase record for `amount = 20.00`, `description = "data"`. If only "Expense" is accepted, this should be an unrecognized command error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

## 5. Acceptance Criteria
*   **AC-01:** The system successfully logs an expense transaction with a valid amount and description when a user provides a correct "Expense [amount] [description]" (or "Expense R[amount] [description]") command.
    *   **AI Verifiable:** Supabase query confirms a new record in the expenses log table with the correct `user_id`, `amount`, `description`, `transaction_type` ('expense'), and `timestamp`.
*   **AC-02:** The system sends a confirmation message to the user in their current language after successfully logging an expense.
    *   **AI Verifiable:** WhatsApp response content matches an expected confirmation format, including the logged amount and description.
*   **AC-03:** The system correctly parses numeric amounts (including decimals) and multi-word descriptions, and handles an optional "R" prefix for the amount.
    *   **AI Verifiable:** Supabase records for test cases like "Expense R35.75 transport costs" show `amount = 35.75` and `description = "transport costs"`.
*   **AC-04:** The system provides clear error messages in the user's language for invalid amount formats or missing mandatory information (if any, like amount).
    *   **AI Verifiable:** WhatsApp responses match predefined error messages. No incorrect expense record is created in Supabase for failed attempts (or logged as 'failed' with a reason).
*   **AC-05:** The expense logging interaction is data-efficient (≤5KB per interaction).
    *   **AI Verifiable:** Network monitoring tool output (or payload size calculation) for each step shows data ≤5KB.

## 6. Dependencies & Assumptions
*   The command parsing logic for "Expense [R][amount] [description]" (and any supported variations) is robust.
*   The Supabase table for expense logging is correctly set up with appropriate fields and data types.
*   The user has the necessary permissions/bundle to use the expense logging feature.

## 7. References
*   PRD Section: 4.2 (Business & Finance - Expense Tracking), 5.2 (Business & Finance Tools - Expense Tracking).
*   High-Level Test Strategy Report Section: 4.2 (Core Business Functionality - Expense Tracking).
*   Master Acceptance Test Plan: HLT-TC-008.
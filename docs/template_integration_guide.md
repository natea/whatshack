# Template Integration Guide: s3rius/FastAPI-template for Township Connect

**Version:** 1.0
**Date:** May 17, 2025
**Author:** AI Assistant (Orchestrator GitHub Template Scout)
**Based on Research Report:** [`docs/research/github_template_research_report.md`](docs/research/github_template_research_report.md)

## 1. Introduction

This document provides a guide for integrating a project structure generated by the `s3rius/FastAPI-template` tool to serve as the foundation for the Python core backend of the "Township Connect" project. The decision to use this generator is based on the findings detailed in the [GitHub Template Research Report](docs/research/github_template_research_report.md).

The `s3rius/FastAPI-template` is a powerful and highly configurable project generator that will allow us to create a tailored FastAPI application with PostgreSQL (via SQLAlchemy), Redis, Alembic for migrations, Poetry for dependency management, and Docker support.

## 2. Selected Template Generator Details

*   **Generator Name:** `s3rius/FastAPI-template`
*   **Source Repository URL:** [`https://github.com/s3rius/FastAPI-template`](https://github.com/s3rius/FastAPI-template)
*   **Installation:** The generator is a Python package installable via pip: `pip install fastapi_template`

## 3. Generation Command and Options for Township Connect

It is recommended to run the following command in a clean temporary directory to generate the project files. The output directory (e.g., `township_connect_py_core`) should then be moved into the main project workspace, for example, under `src/python_core_api/`.

```bash
python -m fastapi_template \
    --name "township_connect_py_core" \
    --api-type rest \
    --db postgresql \
    --orm sqlalchemy \
    --ci github \
    --redis \
    --add_users \
    --migrations \
    --dummy \
    --routers \
    --swagger \
    --loguru \
    --gunicorn \
    --jwt-auth
```

**Explanation of Chosen Options:**

*   `--name "township_connect_py_core"`: Sets the project name.
*   `--api-type rest`: Specifies a REST API.
*   `--db postgresql`: Selects PostgreSQL as the database.
*   `--orm sqlalchemy`: Selects SQLAlchemy as the ORM.
*   `--ci github`: Includes GitHub Actions workflow for CI.
*   `--redis`: Adds Redis support.
*   `--add_users`: Includes `fastapi-users` for basic user management (will need adaptation).
*   `--migrations`: Includes Alembic for database migrations with SQLAlchemy.
*   `--dummy`: Adds dummy models and routers as examples.
*   `--routers`: Adds example routers.
*   `--swagger`: Includes self-hosted Swagger UI.
*   `--loguru`: Integrates Loguru for enhanced logging.
*   `--gunicorn`: Includes Gunicorn as the production server.
*   `--jwt-auth`: Adds JWT authentication support.

Options **not** selected and rationale:
*   `--rabbit`, `--taskiq`, `--kafka`: n8n is the primary orchestrator; Redis with Celery (if explicitly added later from template options or manually) can handle Python-specific tasks if needed.
*   `--kube`, `--traefik`: Deployment is planned for Replit initially.
*   `--prometheus`, `--sentry`, `--opentelemetry`: Can be added later if monitoring requirements demand them.
*   `--cookie-auth`: JWT is generally more suitable for API authentication.

## 4. Expected Output Structure (Illustrative)

The generator will create a project directory (e.g., `township_connect_py_core/`) containing a structure similar to this (actual names might vary based on generator version and choices):

```
township_connect_py_core/
├── .github/                    # GitHub Actions workflows
│   └── workflows/
│       └── main.yml
├── .dockerignore
├── .gitignore
├── Dockerfile                  # For the FastAPI application
├── docker-compose.yml          # For local development (app, db, redis)
├── alembic/                    # Alembic migration scripts
│   └── versions/
├── app/                        # Main application source code
│   ├── __init__.py
│   ├── api/                    # API routers and endpoints
│   │   ├── __init__.py
│   │   ├── deps.py             # Dependency injection
│   │   └── endpoints/          # Endpoint modules (e.g., users, items)
│   ├── core/                   # Core logic, config, security
│   │   ├── __init__.py
│   │   ├── config.py
│   │   └── security.py
│   ├── crud/                   # CRUD operations for models
│   │   └── __init__.py
│   ├── db/                     # Database setup, session, base model
│   │   ├── __init__.py
│   │   ├── base.py
│   │   └── session.py
│   ├── main.py                 # FastAPI application entry point
│   ├── models/                 # SQLAlchemy models
│   │   └── __init__.py
│   ├── schemas/                # Pydantic schemas
│   │   └── __init__.py
│   └── services/               # Business logic services (if generated)
│       └── __init__.py
├── tests/                      # Pytest tests
│   ├── __init__.py
│   ├── conftest.py
│   └── api/
│       └── test_endpoints.py
├── poetry.lock
├── pyproject.toml              # Poetry dependency management
└── README.md                   # Project-specific README
```

The generated files constitute the "template files pulled into the project workspace" and should be placed under a designated subdirectory like `src/python_core_api/`.

## 5. Alignment with Project Requirements

The project generated by `s3rius/FastAPI-template` with the specified options will align well with the Township Connect project's technical requirements by providing:

*   **Python & FastAPI:** A modern Python backend framework.
*   **PostgreSQL & SQLAlchemy & Alembic:** Robust database interaction and migration capabilities compatible with Supabase.
*   **Redis:** Support for caching and potentially message queuing.
*   **Docker & Docker Compose:** Facilitates containerized development and deployment.
*   **Poetry:** Modern dependency management.
*   **`pytest`:** A foundation for testing.
*   **Modularity:** A generally well-organized structure for FastAPI applications.
*   **Configuration:** Standard practices for environment-based configuration.
*   **Authentication:** Basic JWT authentication and user management stubs.

## 6. Required Modifications and Integration Steps

The following specific changes, alterations, or extensions are required to make the generated template fully usable and optimized for the "Township Connect" project. This list expands upon Section 7 of the [GitHub Template Research Report](docs/research/github_template_research_report.md).

### 6.1. Supabase Integration
    *   **Database Connection:**
        *   Update `app/core/config.py` (or equivalent) to load Supabase connection URL, service key, and any other necessary credentials from environment variables (e.g., `.env` file, Replit secrets).
        *   Ensure the SQLAlchemy database URI is constructed using these Supabase credentials.
    *   **SQLAlchemy Models:**
        *   Review and adapt any generated user models (e.g., from `fastapi-users`) in `app/models/` to precisely match the `users` table schema defined in the Project Plan (MT1.2), including fields like `whatsapp_id`, `preferred_language`, `current_bundle`, `popia_consent_given`, `baileys_creds_encrypted` (if applicable).
        *   Create new SQLAlchemy models for other project-specific entities: `service_bundles`, `message_logs`, `payment_transactions`, `sales_logs`, `expense_logs`, `reminders`, `security_logs` as defined in the Project Plan.
    *   **Alembic Migrations:**
        *   Initialize Alembic if not already fully set up for the models.
        *   Generate initial Alembic migrations based on the new/adapted SQLAlchemy models to create the schema in the Supabase database.
        *   Ensure migration scripts are compatible with Supabase's PostgreSQL.
    *   **Row-Level Security (RLS):**
        *   Define and apply RLS policies directly in the Supabase dashboard or via SQL scripts for all tables containing user-specific data (e.g., `users`, `message_logs`, `sales_logs`, etc.).
        *   Ensure application queries and Supabase client configurations (if `supabase-py` is used) are set up to work correctly with RLS (e.g., by passing user JWTs or using appropriate roles).
    *   **Supabase Python Client (`supabase-py`):**
        *   Add `supabase-py` to `pyproject.toml` using Poetry (`poetry add supabase`).
        *   Initialize the Supabase client in `app/db/session.py` or a dedicated Supabase utility module if direct Supabase functionalities (e.g., Auth helpers, storage, edge functions not accessible via standard SQL) are needed. For this project, direct SQL via SQLAlchemy might be sufficient for most DB operations.

### 6.2. Project Structure and Logic
    *   **API Routers:**
        *   Organize API routers in `app/api/endpoints/` based on the features outlined in the Township Connect project plan (e.g., `onboarding.py`, `user_management.py`, `business_tools.py`, `info_services.py`).
        *   Implement the specific command-handling logic within these routers or in service layers they call.
    *   **Service Layer:**
        *   Create a service layer (e.g., in `app/services/`) to encapsulate business logic, separating it from the API endpoint handlers. For instance, `user_service.py`, `popia_service.py`, `payment_service.py`.
    *   **Core Handler Logic:**
        *   The primary interaction model involves n8n calling Python scripts/endpoints. Design `app/main.py` or specific router endpoints to receive data (e.g., JSON payloads) from n8n.
        *   The `core_handler.py` concept from the Project Plan will be distributed across these FastAPI endpoints and services.

### 6.3. Feature Implementation (referencing Project Plan Micro-tasks)
    *   **User Onboarding & Management (Phase 2 of Project Plan):**
        *   Implement user identification, creation (MT2.1).
        *   POPIA notice presentation and consent logging (MT2.2).
        *   Language auto-detection and storage (MT2.3) - create `language_utils.py`.
        *   Manual language switching (MT2.4).
        *   Self-service data erasure (MT2.5) - requires Supabase SQL function `hard_delete_user_data`.
        *   Service bundle selection (MT2.7).
    *   **Business & Finance Tools (Phase 3 of Project Plan):**
        *   Logic to call n8n workflow for payment link generation (MT3.3).
        *   Sales logging (MT3.4).
        *   Expense tracking (MT3.5).
    *   **Logistics, Info & Learning (Phase 4 of Project Plan):**
        *   Implement mock parcel tracking, placeholder directions, Q&A from static files, learning content access.
    *   **Security Logging (MT5.3):**
        *   Implement logging to the `security_logs` table.

### 6.4. Content Management
    *   Create the `content/` directory at the root of the generated project (e.g., `src/python_core_api/content/`).
    *   Populate with multilingual text files for POPIA notices, welcome messages, prompts, Q&A answers, tips, and guides as specified in the Project Plan.
    *   Implement utility functions (e.g., in `app/core/config.py` or a new `app/utils/content_loader.py`) to easily load this content based on language codes.

### 6.5. Testing
    *   **Unit Tests:** Expand `pytest` tests in the `tests/` directory to cover all implemented CRUD operations, services, utility functions, and endpoint logic specific to Township Connect. Aim for high coverage (>70-80%).
    *   **Integration Tests:** Write integration tests that verify interactions with the Supabase database (data persistence, RLS) and Redis.
    *   **Data Efficiency Stubs:** Implement stubs or actual logic for `data_size_kb` calculation in `message_logs`.

### 6.6. Configuration
    *   Thoroughly review `app/core/config.py` and ensure all sensitive values (Supabase URL/keys, Redis URL, API secrets, etc.) are loaded from environment variables.
    *   Provide a comprehensive `.env.example` file.

### 6.7. Dependency Management
    *   Use `poetry add <package_name>` to add any additional Python dependencies (e.g., `supabase-py`).
    *   Keep `pyproject.toml` and `poetry.lock` committed.

### 6.8. Documentation
    *   Update the generated `README.md` to reflect the Township Connect project, its specific setup, and how to run it.
    *   Ensure API documentation via Swagger/OpenAPI is comprehensive for all implemented endpoints.

## 7. Conclusion

The `s3rius/FastAPI-template` generator provides a strong, modern, and configurable foundation for the Township Connect Python backend. By following the generation steps and then systematically applying the modifications outlined above, the project can significantly accelerate its development lifecycle while adhering to best practices.

This integration guide, along with the [GitHub Template Research Report](docs/research/github_template_research_report.md), will inform subsequent planning, specification, and architectural updates.